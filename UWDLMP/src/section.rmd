Statistics
==========================

Row
-----------------------------------------------------------------------

### Demographic Parity

We measure demographic parity using the proportion of each demographic and age subpopulation that was given drug testing.
If no intervention date was given, then the same table will show for both pre and post intervention sections.
<br/>**Goal**: Achieve parity in all race and age groups

Row
-----------------------------------------------------------------------

### Logistic regression model - Pre Intvervention
```{r}
# check if QI intervetion date is available
if (sum(is.na(data$pre_post_QI)) == nrow(data)) {
  glm_pre <- glm(uds_test ~ race_group + age_group, data=data, family = "binomial") %>% 
    tbl_regression(add_estimate_to_reference_rows=TRUE,
                   label = list(age_group ~ "Age group",
                                race_group ~ "Race group")) %>%
    as_gt()

  div(style='height:100%; overflow-y: scroll', glm_pre)
} else {
  # if QI date not available
  glm_pre <- glm(uds_test ~ race_group + age_group, data=data %>% filter(pre_post_QI=="Pre"), family = "binomial") %>% 
    tbl_regression(add_estimate_to_reference_rows=TRUE,
                   label = list(age_group ~ "Age group",
                                race_group ~ "Race group")) %>%
    as_gt()

  div(style='height:100%; overflow-y: scroll', glm_pre)
}
```

### Logistic regression model - Post Intvervention
```{r}
if (sum(is.na(data$pre_post_QI)) == nrow(data)) {
  glm_post <- glm(uds_test ~ race_group + age_group, data=data, family = "binomial") %>% 
    tbl_regression(add_estimate_to_reference_rows=TRUE,
                   label = list(age_group ~ "Age group",
                                race_group ~ "Race group")) %>%
      as_gt()

  div(style='height:100%; overflow-y: scroll', glm_post)
} else {
  glm_post <- glm(uds_test ~ race_group + age_group, data=data %>% filter(pre_post_QI=="Post"), family = "binomial") %>% 
    tbl_regression(add_estimate_to_reference_rows=TRUE,
                   label = list(age_group ~ "Age group",
                                race_group ~ "Race group")) %>%
    as_gt()

  div(style='height:100%; overflow-y: scroll', glm_post)
}
```

Row
-----------------------------------------------------------------------

### Predictive Parity
We measure predictive parity as the proportion of each demographic's subpopulation that tested positive for THC or Non-THC drugs.
If no intervention date was given, then the same table will show for both pre and post intervention sections.
<br/>**Goal**: Achieve parity in all race groups and drug detection types

Row
-----------------------------------------------------------------------

### Non-THC Logistic regression model - Pre Intvervention
```{r}
if (sum(is.na(data$pre_post_QI)) == nrow(data)) {
  glm_pre <- glm(non_thc_detect ~ race_group + age_group, data=data, family = "binomial") %>% 
    tbl_regression(add_estimate_to_reference_rows=TRUE,
                   label = list(age_group ~ "Age group",
                                race_group ~ "Race group")) %>%
  as_gt()

  div(style='height:100%; overflow-y: scroll', glm_pre)
} else {
  glm_pre <- glm(non_thc_detect ~ race_group + age_group, data=data %>% filter(pre_post_QI=="Pre"), family = "binomial") %>% 
    tbl_regression(add_estimate_to_reference_rows=TRUE,
                   label = list(age_group ~ "Age group",
                                race_group ~ "Race group")) %>%
  as_gt()

  div(style='height:100%; overflow-y: scroll', glm_pre)
}
```

### Non-THC Logistic regression model - Post Intvervention
```{r}
if (sum(is.na(data$pre_post_QI)) == nrow(data)) {
  glm_post <- glm(non_thc_detect ~ race_group + age_group, data=data, family = "binomial") %>% 
    tbl_regression(add_estimate_to_reference_rows=TRUE,
                   label = list(age_group ~ "Age group",
                                race_group ~ "Race group")) %>%
  as_gt()

  div(style='height:100%; overflow-y: scroll', glm_pre)
} else {
  glm_post <- glm(non_thc_detect ~ race_group + age_group, data=data %>% filter(pre_post_QI=="Post"), family = "binomial") %>% 
    tbl_regression(add_estimate_to_reference_rows=TRUE,
                   label = list(age_group ~ "Age group",
                                race_group ~ "Race group")) %>%
  as_gt()

  div(style='height:100%; overflow-y: scroll', glm_pre)
}
```

### THC Logistic regression model - Pre Intvervention
```{r}
if (sum(is.na(data$pre_post_QI)) == nrow(data)) {
  glm_pre <- glm(thc_detect ~ race_group + age_group, data=data, family = "binomial") %>% 
    tbl_regression(add_estimate_to_reference_rows=TRUE,
                   label = list(age_group ~ "Age group",
                                race_group ~ "Race group")) %>%
  as_gt()
  
  div(style='height:100%; overflow-y: scroll', glm_pre)
} else {
  glm_pre <- glm(thc_detect ~ race_group + age_group, data=data %>% filter(pre_post_QI=="Pre"), family = "binomial") %>% 
    tbl_regression(add_estimate_to_reference_rows=TRUE,
                   label = list(age_group ~ "Age group",
                                race_group ~ "Race group")) %>%
  as_gt()
  
  div(style='height:100%; overflow-y: scroll', glm_pre)
}
```

### THC Logistic regression model - Post Intvervention
```{r}
if (sum(is.na(data$pre_post_QI)) == nrow(data)) {
  glm_post <- glm(thc_detect ~ race_group + age_group, data=data, family = "binomial") %>% 
    tbl_regression(add_estimate_to_reference_rows=TRUE,
                   label = list(age_group ~ "Age group",
                                race_group ~ "Race group")) %>%
  as_gt()
  
  div(style='height:100%; overflow-y: scroll', glm_pre)
} else {
  glm_post <- glm(thc_detect ~ race_group + age_group, data=data %>% filter(pre_post_QI=="Post"), family = "binomial") %>% 
    tbl_regression(add_estimate_to_reference_rows=TRUE,
                   label = list(age_group ~ "Age group",
                                race_group ~ "Race group")) %>%
  as_gt()
  
  div(style='height:100%; overflow-y: scroll', glm_pre)
}
```

Row
-----------------------------------------------------------------------

### Equal Outcomes for non tested mothers

We measure equal outcomes for non tested mothers using the proportion of each demographic subpopulation that were reported to CPS **without** an UDS indicating non-THC drug use. There may be other evidence not available in this dataset that would be relevant to such a report, so this visual serves to illustrate the relationship between non-testing and CPS report only.
If no intervention date was given, then the same table will show for both pre and post intervention sections.
<br/>**Goal**: Achieve parity in all race groups

Row
-----------------------------------------------------------------------

### Non tested mothers' Logistic regression model - Pre Intvervention
```{r}
# check if CPS report data is available
if(!is.na(error_cps)) {
  print(error_cps)
} else {
  if (sum(is.na(data$pre_post_QI)) == nrow(data)) {
    glm_pre <- glm(cps_report ~ race_group + age_group, data=data %>% filter(!uds_test), family = "binomial") %>% 
      tbl_regression(add_estimate_to_reference_rows=TRUE,
                     label = list(age_group ~ "Age group",
                                  race_group ~ "Race group")) %>%
      as_gt()
    
    div(style='height:100%; overflow-y: scroll', glm_pre)
  } else {
    glm_pre <- glm(cps_report ~ race_group + age_group, data=data %>% filter(pre_post_QI=="Pre" & !uds_test), family = "binomial") %>% 
      tbl_regression(add_estimate_to_reference_rows=TRUE,
                     label = list(age_group ~ "Age group",
                                  race_group ~ "Race group")) %>%
      as_gt()
    
    div(style='height:100%; overflow-y: scroll', glm_pre)
  }
}
```

### Non tested mothers' Logistic regression model - Post Intvervention
```{r}
if(!is.na(error_cps)) {
  print(error_cps)
} else {
  if (sum(is.na(data$pre_post_QI)) == nrow(data)) {
    glm_post <- glm(cps_report ~ race_group + age_group, data=data %>% filter(!uds_test), family = "binomial") %>% 
      tbl_regression(add_estimate_to_reference_rows=TRUE,
                     label = list(age_group ~ "Age group",
                                  race_group ~ "Race group")) %>%
      as_gt()

    div(style='height:100%; overflow-y: scroll', glm_pre)
  } else {
    glm_post <- glm(cps_report ~ race_group + age_group, data=data %>% filter(pre_post_QI=="Post" & !uds_test), family = "binomial") %>% 
      tbl_regression(add_estimate_to_reference_rows=TRUE,
                     label = list(age_group ~ "Age group",
                                  race_group ~ "Race group")) %>%
      as_gt()

    div(style='height:100%; overflow-y: scroll', glm_pre)
  }
}
```

### Tested mothers' Logistic regression model - Pre Intvervention
```{r}
if(!is.na(error_cps)) {
  print(error_cps)
} else {
  if (sum(is.na(data$pre_post_QI)) == nrow(data)) {
    glm_pre <- glm(cps_report ~ race_group + age_group, data=data %>% filter(uds_test), family = "binomial") %>% 
      tbl_regression(add_estimate_to_reference_rows=TRUE,
                     label = list(age_group ~ "Age group",
                                  race_group ~ "Race group")) %>%
      as_gt()

    div(style='height:100%; overflow-y: scroll', glm_pre)
  } else {
    glm_pre <- glm(cps_report ~ race_group + age_group, data=data %>% filter(pre_post_QI=="Pre" & uds_test), family = "binomial") %>% 
      tbl_regression(add_estimate_to_reference_rows=TRUE,
                     label = list(age_group ~ "Age group",
                                  race_group ~ "Race group")) %>%
      as_gt()

    div(style='height:100%; overflow-y: scroll', glm_pre)
  }
}
```

### Tested mothers' Logistic regression model - Post Intvervention
```{r}
if(!is.na(error_cps)) {
  print(error_cps)
} else {
  if (sum(is.na(data$pre_post_QI)) == nrow(data)) {
    glm_post <- glm(cps_report ~ race_group + age_group, data=data %>% filter(uds_test), family = "binomial") %>% 
      tbl_regression(add_estimate_to_reference_rows=TRUE,
                     label = list(age_group ~ "Age group",
                                  race_group ~ "Race group")) %>%
      as_gt()

    div(style='height:100%; overflow-y: scroll', glm_pre)
  } else {
    glm_post <- glm(cps_report ~ race_group + age_group, data=data %>% filter(pre_post_QI=="Post" & uds_test), family = "binomial") %>% 
      tbl_regression(add_estimate_to_reference_rows=TRUE,
                     label = list(age_group ~ "Age group",
                                  race_group ~ "Race group")) %>%
      as_gt()

    div(style='height:100%; overflow-y: scroll', glm_pre)
  }
}
```